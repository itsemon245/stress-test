config:
  # Set from env at runtime (recommended). Fallback to a placeholder for readability.
  target: "{{ $env.BASE_URL }}"
  phases:
    # MULTI-CONNECTION TEST: Each Chrome instance = 5 WebSocket connections
    # Target: ~250 total WebSocket connections = 50 Chrome instances
    # - duration: 60
    #   arrivalRate: 1
    #   rampTo: 2
    #   name: "gentle-ramp"

    # Sustained test: 1 Chrome/sec = 5 WebSocket connections/sec
    # Peak concurrent: ~50 Chrome instances = ~250 WebSocket connections
    - duration: 60
      arrivalRate: 1
      name: "multi-connection-test"

    # # Cool down
    # - duration: 30
    #   arrivalRate: 1
    #   name: "cooldown"

  # Filter out asset requests from reports (they still load, just not counted)
  http:
    extendedMetrics: true
    skipUnmatchedRequests: true
    match:
      - regexp: ".*/(personal-designs).*"
        as: "main-requests"
    excludeRequests:
      - "**/*.js"
      - "**/*.css"
      - "**/*.png"
      - "**/*.jpg"
      - "**/*.jpeg"
      - "**/*.gif"
      - "**/*.svg"
      - "**/*.woff*"
      - "**/*.ttf"
      - "**/*.eot"
      - "**/*.ico"
      - "**/*.webp"
      - "**/fonts/**"
      - "**/images/**"
      - "**/assets/**"
      - "**/static/**"

  # Playwright (Chromium) is built into Artillery:
  engines:
    playwright:
      aggregateByName: true
      showAllPageMetrics: true
      launchOptions:
        headless: true # set to false for local debugging
        args:
          [
            "--no-sandbox",
            "--disable-dev-shm-usage",
            "--disable-gpu",
            "--disable-web-security",
            "--disable-features=TranslateUI",
            "--disable-ipc-flooding-protection",
            "--disable-background-timer-throttling",
            "--disable-renderer-backgrounding",
            "--disable-backgrounding-occluded-windows",
            "--disable-background-networking",
            "--memory-pressure-off",
            "--max_old_space_size=4096",
          ]

  # Your Playwright code (JS/TS) lives here:
  processor: "./flows-optimized.js"

  # Pass values into the test (can come from env via $env.*)
  variables:
    AUTH_URL: "{{ $env.AUTH_URL }}" # full URL to your GET auth endpoint
    PERSONAL_PATH: "{{ $env.PERSONAL_PATH }}" # e.g. /personal-designs
    ECHO_TIMEOUT_MS: "{{ $env.ECHO_TIMEOUT_MS }}"
    CONNECTIONS_PER_INSTANCE: "{{ $env.CONNECTIONS_PER_INSTANCE }}" # Default: 4 connections per Chrome (stays under asset limit)

scenarios:
  - name: "Auth â†’ /personal-designs (Echo connects)"
    engine: playwright
    testFunction: personalDesignsFlow
