user                 www-data;
worker_processes     auto;
worker_rlimit_nofile 100000;
pid                  /run/nginx.pid;

events {
    # CRITICAL: Max connections per worker process
    # Higher = More concurrent connections (4 workers Ã— 8192 = 32,768 total)
    # Lower = Connection refused errors under high load
    # Impact: Too low causes "connection refused", too high causes memory exhaustion
    worker_connections                  8192;
    
    # Accept multiple connections at once (performance optimization)
    multi_accept                        on;
    
    # CRITICAL: Optimize for high concurrent connection handling
    # Higher = Better performance under heavy load (like 250+ connections)
    # Lower = More conservative resource usage
    # Impact: Improves connection handling when approaching 200+ concurrent connections
    use epoll;
}

http {
    include                             /etc/nginx/mime.types;
    default_type                        application/octet-stream;

    server_tokens                       off;
    sendfile                            on;
    tcp_nopush                          on;
    tcp_nodelay                         on;
    send_timeout                        120;
    reset_timedout_connection           on;
    
    # CRITICAL: Keep connections alive longer to reduce connection overhead
    # Higher = Better performance, fewer connection establishments
    # Lower = More CPU/memory overhead from constant reconnections
    # Impact: Too low (like 5s) causes connection churn; too high wastes server resources
    keepalive_timeout                   30;
    
    # CRITICAL: Max requests per keepalive connection
    # Higher = Better performance under sustained load (like load testing)
    # Lower = More connection overhead and slower response times
    # Impact: Too low causes frequent reconnections; too high may cause memory leaks in poor clients
    keepalive_requests                  10000;
    types_hash_max_size                 2048;
    fastcgi_read_timeout                360;
    fastcgi_buffer_size                 64k;
    fastcgi_buffers                     4 64k;
    # CRITICAL: Buffer sizes for WebSocket event handling
    # Higher = Less disk I/O, better performance for large WebSocket payloads
    # Lower = More memory efficient but causes temporary file usage
    # Impact: Too low causes disk buffering at 178+ connections; too high uses excessive RAM
    client_body_buffer_size             32M;  # Increased from 10M to handle WebSocket events in memory
    client_max_body_size                100M;
    client_body_timeout                 120;
    client_header_timeout               120;
    client_body_in_file_only            clean;
    # CRITICAL: File descriptor cache for frequently accessed files
    # Higher inactive time = Better performance, files stay cached longer
    # Lower inactive time = More disk I/O under sustained load
    # Impact: Too low (20s) causes cache churn; too high wastes memory on unused files
    open_file_cache                     max=200000 inactive=60s;
    
    # CRITICAL: How often to check if cached file info is still valid
    # Higher = Less CPU overhead, but slower detection of file changes
    # Lower = More CPU overhead from frequent file stat() calls
    # Impact: Under high load, frequent validation causes CPU spikes
    open_file_cache_valid               60s;
    open_file_cache_min_uses            2;
    open_file_cache_errors              on;
    proxy_connect_timeout               60;
    proxy_read_timeout                  60;
    proxy_send_timeout                  60;
    server_name_in_redirect             off;
    
    # CRITICAL: Connection limiting zone definition (must be in http block)
    # Higher zone size = Can track more IPs simultaneously  
    # Lower zone size = Less memory usage but may not track all IPs under high load
    # Impact: Too low causes "could not allocate" errors; too high wastes RAM
    limit_conn_zone $binary_remote_addr zone=perip:10m;

    # settings from nginx bad bot blocker moved here
    server_names_hash_bucket_size 256;
    server_names_hash_max_size 4096;
    variables_hash_max_size 4096;
    variables_hash_bucket_size 4096;
    ###

    ssl_session_cache                   shared:SSL:20m;
    ssl_session_timeout                 10m;
    ssl_prefer_server_ciphers           on;
    ssl_ciphers                         'ECDHE-RSA-AES128-GCM-SHA256:ECDHE-ECDSA-AES128-GCM-SHA256:ECDHE-RSA-AES256-GCM-SHA384:ECDHE-ECDSA-AES256-GCM-SHA384:DHE-RSA-AES128-GCM-SHA256:DHE-DSS-AES128-GCM-SHA256:kEDH+AESGCM:ECDHE-RSA-AES128-SHA256:ECDHE-ECDSA-AES128-SHA256:ECDHE-RSA-AES128-SHA:ECDHE-ECDSA-AES128-SHA:ECDHE-RSA-AES256-SHA384:ECDHE-ECDSA-AES256-SHA384:ECDHE-RSA-AES256-SHA:ECDHE-ECDSA-AES256-SHA:DHE-RSA-AES128-SHA256:DHE-RSA-AES128-SHA:DHE-DSS-AES128-SHA256:DHE-RSA-AES256-SHA256:DHE-DSS-AES256-SHA:DHE-RSA-AES256-SHA:AES128-GCM-SHA256:AES256-GCM-SHA384:AES128-SHA256:AES256-SHA256:AES128-SHA:AES256-SHA:AES:CAMELLIA:DES-CBC3-SHA:!aNULL:!eNULL:!EXPORT:!DES:!RC4:!MD5:!PSK:!aECDH:!EDH-DSS-DES-CBC3-SHA:!EDH-RSA-DES-CBC3-SHA:!KRB5-DES-CBC3-SHA';
    ssl_protocols                       TLSv1.1 TLSv1.2;

    log_format                          main '[$time_local] $remote_user $remote_addr $http_x_forwarded_for "$host" "$request" '
                                        '$status $body_bytes_sent "$http_referer" '
                                        '"$http_user_agent" $request_time "$request_body"' ;
    access_log                          /var/log/nginx/access.log main;
    error_log                           /var/log/nginx/error.log  info;

    gzip                                on;
    gzip_disable                        "MSIE [1-6]\.(?!.*SV1)";
    gzip_vary                           on;
    gzip_proxied                        any;
    gzip_comp_level                     7;
    gzip_buffers                        16 8k;
    gzip_http_version                   1.1;
    gzip_types
        application/atom+xml
        application/javascript
        application/json
        application/rss+xml
        application/vnd.ms-fontobject
        application/x-font-ttf
        application/x-web-app-manifest+json
        application/xhtml+xml
        application/xml
        font/opentype
        image/svg+xml
        image/x-icon
        text/css
        text/plain
        text/x-component
        text/xml
        text/javascript;

    ##
    # Virtual Host Configs
    ##

    include                             /etc/nginx/conf.d/*.conf;
    include                             /etc/nginx/sites-enabled/*.conf;
}
