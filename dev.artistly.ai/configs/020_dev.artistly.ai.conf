map $http_upgrade $connection_upgrade {
  default upgrade;
  ''      close;
}

server {

    listen                         *:80;
    listen                      [::]:80;

    include                     /etc/nginx/sites.d/ports_https.conf;
    include                     /etc/nginx/sites.d/ssl_main.conf;
    include                     /etc/nginx/sites.d/ssl_redirect.conf;

    #include                     /etc/nginx/bots.d/blockbots.conf;
    #include                     /etc/nginx/bots.d/ddos.conf;

    ssl_certificate             /etc/letsencrypt/live/dev.artistly.ai/fullchain.pem; # managed by Certbot
    ssl_certificate_key         /etc/letsencrypt/live/dev.artistly.ai/privkey.pem; # managed by Certbot

    server_name                 dev.artistly.ai;

    root                        /var/www/dev.artistly.ai/webroot/public;
    index                       index.php;

    server_tokens               off;
    charset                     utf-8;
    client_body_in_file_only    clean;
    client_body_buffer_size     64K;
    client_max_body_size        2G;
    sendfile                    on;
    send_timeout                60s;

    access_log                  /var/log/nginx/dev.artistly.ai_access.log main;
    error_log                   /var/log/nginx/dev.artistly.ai_error.log  info;

    # Cache static files
    location ~* \.(js|css|png|jpg|jpeg|gif|ico|svg|woff|woff2)$ {
        expires 1y;
        add_header Cache-Control "public, immutable";
        add_header Vary Accept-Encoding;
        
        # Enable efficient file sending
        sendfile on;
        sendfile_max_chunk 1m;
        tcp_nopush on;
        tcp_nodelay on;
        
        # Increase buffer sizes for large static files  
        output_buffers 1 32k;
        postpone_output 1460;
    }

    location / {
        try_files              $uri $uri/ /index.php?$query_string;
    }

    #Proxy for REVERB
    location /app {
            proxy_pass http://127.0.0.1:7001;

            proxy_http_version 1.1;
            proxy_set_header Upgrade $http_upgrade;
            proxy_set_header Connection $connection_upgrade;
            proxy_set_header Host $host;
            # carry over IP/auth if you use private channels
            proxy_set_header X-Real-IP      $remote_addr;
            proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
            proxy_set_header Cookie         $http_cookie;
            proxy_set_header Authorization  $http_authorization;
            proxy_set_header Origin         $http_origin;

            proxy_buffering    off;

            proxy_connect_timeout 60s;
            proxy_read_timeout 1800s;
            proxy_send_timeout 1800s;
    }

    location  ~ \.php$ {
        try_files                           $uri =404;
        expires                             off;
        fastcgi_read_timeout                120;
        fastcgi_pass                        unix:/var/run/php/php8.3-fpm_dev.artistly.ai.sock;
        fastcgi_keep_conn                   on;
        include                             fastcgi_params;
        fastcgi_param                       HTTPS on;
        fastcgi_param                       REQUEST_SCHEME https;
        fastcgi_param                       SCRIPT_FILENAME $document_root${fastcgi_script_name};
    }

}
